---
Title: DataCronアーキテクチャ構想: TTLトリガーによるスケーラブルな定期データパイプライン
Category:
- Architecture
Draft: true
CustomPath: 2017/datacron-architecture
---

この記事は[第1回ウェブシステムアーキテクチャ(WSA)研究会](http://websystemarchitecture.hatenablog.jp/)の原稿です。

cronのようなタイムトリガーにより定期的に実行されるバッチ処理の課題を解決するアーキテクチャを最近考えている。
この記事では、サーバなどの処理主体がタスクスケジューリングするcronベースの手法に代えて、データに対してタイマーと処理を仕込むことでスケールさせやすい構造にできないか、という提案を試みる。この構造変更を「DataCronアーキテクチャ」と呼ぶことにする。

# はじめに

[http://blog.yuuk.io/entry/the-rebuild-of-tsdb-on-cloud:title:bookmark]における時系列データベースアーキテクチャでは、特性の異なる3種類の分散データストアを組み合わせ、古いデータを遅いディスクへ徐々に逃していくことにより、性能とコストを最適化した。データストア実装として、インメモリDB（Redis Cluster）、オンディスクDB（Amazon DynamoDB）、オブジェクトストレージ（Amazon S3）を採用している。
このアーキテクチャを考える上で重要なのは、どのようにデータを移動させるかということだった。
まず、cronのようなタイムスケジューラーにより、バッチ処理を走らせ、データレコードを走査し、一定以上古いタイムスタンプをもつレコードを読み出し、次のデータストアへ書き込むという素朴な手法を考えた。

この手法は、SRE本[Bet17]の25.1節「パイプラインのデザインパターンの起源」にあるように、データパイプラインと定義されるデザインパターンに分類できる。

>
データ処理に対する旧来のアプローチは、データを読み取り、希望する何らかの方法でそのデー タを変換し、新しいデータを出力するプログラムを書くというものでした。通常こういったプログラムは、cron のような定期スケジューリングを行うプログラムの制御の下でスケジュール実行されました。このデザインパターンはデータパイプラインと呼ばれます。
> 「SRE サイトリライアビリティエンジニアリング ――Googleの信頼性を支えるエンジニアリングチーム」

定期データパイプラインの欠点として、25.3節「定期的なパイプラインパターンでの課題」にて、期限内に実行が終わらないジョブ、リソースの枯渇、処理の進まないチャンクとそれに伴う運用負荷が挙げられている。
時系列データベースの例では、レコード数が増加するにつれ、ジョブの実行時間が増加し、アプリケーションが想定する時間内に終わらない可能性がある。
ジョブの実行時間を減らすために、バッチ処理の並列度を上げたとしても、読み出しと書き出し先の双方のデータストアのリソース消費量が増加する。
さらに、実行中に失敗する可能性を考慮すると、実行時間の保証が難しくなるかつ、処理の冪等性を求められる。

時系列データベースのアーキテクチャでは、これをデータストアのレコード単位のTTLを利用して解決した。
具体的には、データストアに書き込むときに、レコードに対してTTL（Time To Live）を設定し、TTLが期限切れになったタイミングで、トリガーを起動し、期限切れレコードを別のデータストアへ書き込む。
実装は、DynamoDB StreamsとLambda Triggersの組み合わせ[dyn01]とDynamoDBのTTL[dyn02]を利用し、DynamoDBからS3へデータを移動させた。
これにより、パイプライン処理を、バッチ処理ではなく、レコード単位のイベント駆動型処理に置き換えられた。

のちに、TTLを用いたデータパイプラインアーキテクチャを時系列データベース以外のデータパイプラインに応用できないかを考えた。
例えば、機械学習の学習モデルの定期更新や、マルチテナント環境における大量のSSL/TLS証明書[mat17]の定期更新などである。

アイデアの要点は、処理の主体に紐付いたタイムスケジューラーがジョブを起動するのではなく、データに紐付いたタイマーがジョブを起動することだ。
前者のスケジューラーとして、伝統的な実装であるcronがある。
サーバやクラスタではなく、データに対してcronを仕込むという発想から、このアーキテクチャをDataCronアーキテクチャと名付けてみた。

# DataCronアーキテクチャ

## 実装

## 応用

自分の最近の業務経験から、次のようなDataCronアーキテクチャの応用例がある。

### モニタリングシステムの異常検知

機械学習をWebサービスに導入すると、日次パイプラインにより、学習モデルを更新することがある。
データストア上のモデルの更新処理をトリガーとして登録し、モデル更新時にTTLを1日後にセットして再書き込みすれば、日次パイプラインとして機能する。

### 大規模SSL/TLS証明書管理

ブログサービスやレンタルサーバーサービスのようなマルチテナント環境[pep17](https://tech.pepabo.com/2017/08/22/lolipop-free-ssl)にて、大量のSSL/TLS証明書を管理し、数ヶ月ごとに更新しなければいけないケースがある。

# DataCronのデメリット

# むすび

## 参考文献

- [Bet17]: Betsy Beyer, Chris Jones, Jennifer Petoff, Niall Richard Murphy編 澤田武男 関根達夫 細川一茂 矢吹大輔 監訳 Sky株式会社 玉川竜司 訳,「SRE サイトリライアビリティエンジニアリング ――Googleの信頼性を支えるエンジニアリングチーム」,オライリー・ジャパン,2017/08, https://www.oreilly.co.jp/books/9784873117911/
- [dyn01]: "DynamoDB Streams and AWS Lambda Triggers", http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.Lambda.html
- [dyn02]: "Time To Live - Amazon DynamoDB", http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/TTL.html
- [mat17]: 松本亮介, 三宅 悠介, 力武 健次, 栗林 健太郎, 「高集積マルチテナントWebサーバの大規模証明書管理と実運用上の評価」, 情報処理学会研究報告インターネットと運用技術（IOT）,2017-IOT-39, Vol.14, pp.1-8, 2017年9月
- [pep17]: [https://tech.pepabo.com/2017/08/22/lolipop-free-ssl/:title]






<!-- # 概要 -->
<!--  -->
<!-- Webサービスにおいて、ユーザーが発生させるイベントとは異なり、任意の時間周期で任意のバッチ処理を実行させたいことがある。 -->
<!-- 例えば、課金機能のための月次集計処理、機械学習のための学習モデルの定期更新などがある。 -->
<!-- 一般的な手法では、特定サーバ上のcronなどのタイムスケジューラーにより、バッチ処理を実行させる。 -->
<!--  -->
<!-- しかし、このバッチ処理手法には、スケーラビリティと実行時のエラー回復に関する2つの問題がある。 -->
<!-- まず一般に、データベース上の処理対象レコード数が増加するにつれ、バッチ処理の実行時間が増大するため、レコード数に対してスケールしない。 -->
<!-- 次に、実行途中にエラーが発生した場合、再試行したとしても結果が等しくなるように、バッチ処理プログラムを設計する必要がある。 -->
<!--  -->
<!-- これらの2つの問題に対して、DBMSのTTL期限切れイベントをトリガーとし、予め登録された任意の処理を実行するアーキテクチャを考えた。 -->
<!-- このアーキテクチャにより、データレコードごとに処理を記述するため、バッチ処理と比較して、再試行時を考慮したコードを書きやすい。 -->
<!-- さらに、レコード単位のトリガー処理の場合、他の処理プロセスとデータ競合しないため、レコード数に対して処理時間をスケールさせやすい。 -->
<!--  -->
<!-- # はじめに -->
<!--  -->
<!-- Webサービスにおけるサーバサイドの典型的な処理実行方式は、ユーザのクライアント端末からのリクエストに対して同期処理するか、非同期処理するか、ストリーミング処理するかのいずれかである。 -->
<!-- 同期処理では、一般的に、ユーザのリクエストをWebサーバが受信し、Webサーバがユーザに対してレスポンスを送信する。 -->
<!-- 非同期処理では、ユーザのリクエストを契機に遅延処理を登録するイベントトリガー方式と、任意の時刻または任意の周期で処理するタイムトリガー方式 -->
<!-- ユーザのリクエストを契機に、遅延処理イベントとして登録し、遅延処理するか、もしくは任意の時間に処理 -->
<!--  -->
<!-- <!-- - FaaSでいうところのイベントトリガー型スケジューラー --> -->
<!--  -->
<!-- # タイムトリガーの既存手法と課題 -->
<!--  -->
<!-- <!-- - レコード数が増加するにつれ実行時間が増大する --> -->
<!-- <!-- - 処理分割が必要 --> -->
<!--  -->
<!-- # 提案手法 -->
<!--  -->
<!--  -->
<!-- # 実験と考察 -->
<!--  -->
<!-- <!-- - 複数のレコードをまとめる処理がしづらくなる --> -->
<!-- <!-- - バースト制御が難しくなる --> -->
<!-- <!--  --> -->
<!-- <!-- - TTLのexpire時刻と実際の削除時刻のディレイが大きいのはなぜか --> -->
<!-- <!-- - なぜRDBMSでは、TTLがないか --> -->
<!--  -->
<!-- # むすび -->

